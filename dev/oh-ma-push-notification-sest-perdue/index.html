<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>(1/3)Retour du nsec - Introduction au badge hacking</title>
  <meta property="og:title" content="(1/3)Retour du nsec - Introduction au badge hacking" />
  <meta name="twitter:title" content="(1/3)Retour du nsec - Introduction au badge hacking" />
  <meta name="description" content="Je ne suis pas développeur Android et je ne connais pas bien cet environnement. Cependant, dans le cadre d&rsquo;OpenDHT, j&rsquo;ai dû m&rsquo;intéresser un peu aux push notifications.
Pour faire court, cette librairie sert à stocker une table de hashage sur de multiples noeuds (peut-être que je ferais un article plus detaillé, ou un post sur le forum). Chaque noeud du réseau peut écrire (PUT) des valeurs (chiffrées pour un autre noeud ou en clair), lire les valeurs contenues à un hash précis (GET) ou lire en continu (LISTEN) les valeurs d&rsquo;un hash.">
  <meta property="og:description" content="Je ne suis pas développeur Android et je ne connais pas bien cet environnement. Cependant, dans le cadre d&rsquo;OpenDHT, j&rsquo;ai dû m&rsquo;intéresser un peu aux push notifications.
Pour faire court, cette librairie sert à stocker une table de hashage sur de multiples noeuds (peut-être que je ferais un article plus detaillé, ou un post sur le forum). Chaque noeud du réseau peut écrire (PUT) des valeurs (chiffrées pour un autre noeud ou en clair), lire les valeurs contenues à un hash précis (GET) ou lire en continu (LISTEN) les valeurs d&rsquo;un hash.">
  <meta name="twitter:description" content="Je ne suis pas développeur Android et je ne connais pas bien cet environnement. Cependant, dans le cadre d&rsquo;OpenDHT, j&rsquo;ai dû m&rsquo;intéresser un peu aux push notifications.
Pour faire …">
  <meta name="author" content="Sébastien Blin"/>
  <link href='https://enconn.fr/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://enconn.fr/img/avatar-icon.png" />
  <meta name="twitter:image" content="https://enconn.fr/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@AmarOk1412" />
  <meta name="twitter:creator" content="@AmarOk1412" />
  <meta property="og:url" content="https://enconn.fr/dev/oh-ma-push-notification-sest-perdue/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Enconn" />

  <meta name="generator" content="Hugo 0.37.1" />
  <link rel="canonical" href="https://enconn.fr/dev/oh-ma-push-notification-sest-perdue/" />
  <link rel="alternate" href="https://enconn.fr/index.xml" type="application/rss+xml" title="Enconn">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://enconn.fr/css/main.css" />
  <link rel="stylesheet" href="https://enconn.fr/css/pygment_highlights.css" />
  <link rel="stylesheet" href="https://enconn.fr/css/highlight.min.css" />




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://enconn.fr">Enconn</a> <div class="navbar-by">By AmarOk</div>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="/dev" href="/dev/">/dev</a>
            </li>
          
        
          
            <li>
              <a title="/var/log" href="/logs/">/var/log</a>
            </li>
          
        
          
            <li>
              <a title="/usr" href="/page/about/">/usr</a>
            </li>
          
        

        

        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Enconn" href="https://enconn.fr">
            <img class="avatar-img" src="https://enconn.fr/img/avatar-icon.png" alt="Enconn" />
          </a>
        
      </div>
    </div>

  </div>
</nav>




    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="dev-heading">
              <h1>(1/3)Retour du nsec - Introduction au badge hacking</h1>
                
                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        

<p>Je ne suis pas développeur Android et je ne connais pas bien cet environnement. Cependant, dans le cadre d&rsquo;<a href="https://opendht.net">OpenDHT</a>, j&rsquo;ai dû m&rsquo;intéresser un peu aux push notifications.</p>

<p>Pour faire court, cette librairie sert à stocker une table de hashage sur de multiples noeuds (peut-être que je ferais un article plus detaillé, ou un post sur le forum). Chaque noeud du réseau peut écrire (<strong>PUT</strong>) des valeurs (chiffrées pour un autre noeud ou en clair), lire les valeurs contenues à un hash précis (<strong>GET</strong>) ou lire en continu (<strong>LISTEN</strong>) les valeurs d&rsquo;un hash. Le problème, c&rsquo;est que le maintien d&rsquo;un réseau distribué demande de la synchronisation entre ces noeuds (donc un envoi assez conséquent de données) ainsi qu&rsquo;une connexion à ce réseau. Ces deux points ne sont pas assurés sur des appareils mobiles, qui demandent géneralement de limiter les datas consommées (sauf en Europe&hellip;) et qui pousse l&rsquo;économie de batterie en coupant la connectivité ou même les applications (donc, quand le téléphone passe en veille, le noeud se trouve inactif). Pour le premier point, un noeud peut demander à un autre noeud du réseau de lui servir de proxy et d&rsquo;écouter le réseau à sa place (ce qui évite de se synchroniser, tout en étant le seul à pouvoir déchiffrer le contenu qui lui est destiné). Pour la coupure de la connectivité, la solution la plus fiable et simple pour l&rsquo;utilisateur est l&rsquo;utilisation de push notifications. Ainsi, le proxy peut envoyer une <em>wake up</em> notification pour donner un peu de temps au noeud de récuperer via le proxy les valeurs à déchiffrer.</p>

<p>Bref, <em>seems simple</em>&hellip; et après quelques semaines de dev, tout marche relativement bien. Vient la partie debug, qui, au final, va nous faire découvrir toute une épopée pour certaines de ces notifications.</p>

<h1 id="cycle-de-vie-d-une-notification">Cycle de vie d&rsquo;une notification</h1>

<p>Tout d&rsquo;abord, voici l&rsquo;aventure normale d&rsquo;une push notification telle que racontée dans les contes pour enfants:</p>

<ol>
<li>Mon noeud sur le bateau du robot (Android) ou de la pomme (Apple) demande via la radio à un autre noeud sur la terre d&rsquo;écouter le monde à sa place.</li>
<li>La nuit tombe sur le bateau, après quelques minutes la salle de la radio est fermée et le noeud sur le bateau ne peut pas communiquer avec la terre.</li>
<li>Le noeud sur terre reçoit un message urgent à livrer au noeud du bateau, mais ne peut plus lui communiquer par radio. Il demande donc à un service du robot ou de la pomme d&rsquo;envoyer une super push notification d&rsquo;aller réveiller le noeud sur le bateau.</li>
<li>La push notification voyage très vite jusqu&rsquo;au bateau et réveille le capitaine.</li>
<li>Le capitaine va alors réveiller le noeud et lui donne accés a la radio pour quelques minutes</li>
<li>Le noeud du bateau peut demander le message pour lui au noeud sur la terre.</li>
</ol>

<p>Sauf que dans la vraie vie, l&rsquo;histoire peut se finir mal.</p>

<h1 id="problèmes">Problèmes</h1>

<h2 id="problème-1-une-nuit-trop-sombre">Problème 1 : Une nuit trop sombre</h2>

<p>Sur certains téléphones Android, l&rsquo;optimisation de la batterie est un peu trop forte. Certains constructeurs (ex, Oppo, Xiami, One plus) font en sorte que lorsque Android tue une application pour optimiser la batterie, le système tue aussi les taches de fonds reliées à ce processus, dont celles utilisées par Firebase pour que la push notification arrive. Dans ce cas&hellip; la push notification arrive sur le bateau mais le capitaine n&rsquo;arrive pas à réveiller le noeud à temps, tout le monde meurt&hellip; Il est aussi nécessaire de noter que ce problème arrive relativement peu pour les applications connues. Mais une whitelist de certaines applications populaires est possible de la part des constructeurs.</p>

<p>Solution : sur certaines de ces ROMs, il existe une option pour pouvoir réveiller les taches de fonds, mais ça demande du travail manuel à l&rsquo;utilisateur&hellip; Pas viable et souvent l&rsquo;option est difficile à trouver.</p>

<h2 id="problème-2-une-nuit-encore-plus-sombre">Problème 2: Une nuit encore plus sombre</h2>

<p>Même s&rsquo;il est possible de pouvoir désactiver l&rsquo;optimisation batterie pour certaines applications depuis certaines ROM, parfois celle-ci est tellement forte que le téléphone lui-même n&rsquo;a pas l&rsquo;air de recevoir une seule notification (vu sur quelques Huawei ou Xiaomi). Je n&rsquo;ai pas de solution viable à part laisser le téléphone branche. Ce scénario résulte dans le fait que la push notification n&rsquo;arrive même pas sur le bateau mais s&rsquo;explose dessus, tout le monde meurt.</p>

<h2 id="problème-3-une-mer-dechainée">Problème 3 : Une mer dechainée</h2>

<p>Les téléphones doivent maintenir une socket avec le service du robot ou de la pomme. Pour maintenir cette connexion, elle est utilisée pour transmettre un petit message (<em>heartbeet</em>) toutes les X minutes (généralement entre 15 et 30 minutes). Si ce message n&rsquo;est pas reçu (délais, téléphone sans connexion, etc.), alors le téléphone n&rsquo;est plus connecté et ne va pas recevoir la notification. Dans ce scénario, le bateau est juste perdu en mer et la notification ne trouve jamais le bateau, tout le monde meurt.</p>

<h2 id="problème-4-la-notification-meurt-en-mer">Problème 4 : La notification meurt en mer</h2>

<p>Dans certains cas, la notification peut mourrir à cause d&rsquo;un TTL trop faible donne par FCM (Firebase, service d&rsquo;Android). Le bateau n&rsquo;est jamais prévenu, tout le monde meurt.</p>

<h2 id="problème-5-le-capitaine-ignore-la-notification">Problème 5 : Le capitaine ignore la notification</h2>

<p>Parfois le téléphone s&rsquo;enregistre auprès du service relié. Pendant cette période, le téléphone peut recevoir une notification sans être prêt et ne va pas réveiller l&rsquo;application destinataire. Dans ce cas, le capitaine se reccouche, tout le monde meurt.</p>

<h2 id="problème-6-la-mer-est-inconnue-et-dangereuse">Problème 6 : La mer est inconnue et dangereuse</h2>

<p>Ce problème regroupe tous les autres possibles, une règle de firewall, un drop de paquet, etc. Dans ce scénario, la push notification est enlevée par des pirates, revendue comme esclave et tout le monde remeurt.</p>

<h1 id="morale-de-l-histoire">Morale de l&rsquo;histoire</h1>

<p>Il fait pas bon de naviguer en mer. Le réseau, c&rsquo;est parfois complexe et pas marrant à debugger.</p>

<h2 id="quelques-liens">Quelques liens</h2>

<ul>
<li><a href="https://medium.freecodecamp.org/why-your-push-notifications-never-see-the-light-of-day-3fa297520793">https://medium.freecodecamp.org/why-your-push-notifications-never-see-the-light-of-day-3fa297520793</a></li>
<li><a href="https://www.moengage.com/blog/tagpush-notification-not-getting-delivered/">https://www.moengage.com/blog/tagpush-notification-not-getting-delivered/</a> (interessant +)</li>
<li><a href="https://productforums.google.com/forum/#!topic/nexus/fslYqYrULto%5B1-25%5D">https://productforums.google.com/forum/#!topic/nexus/fslYqYrULto%5B1-25%5D</a> (interessant ++)</li>
<li><a href="https://github.com/firebase/quickstart-android/issues/41">https://github.com/firebase/quickstart-android/issues/41</a></li>
<li><a href="https://github.com/wix/react-native-notifications/issues/42">https://github.com/wix/react-native-notifications/issues/42</a></li>
</ul>

      </article>

      <ul class="pager blog-pager">
        
          <li class="previous">
            <a href="https://enconn.fr/dev/2-3-retour-du-nsec-the-visual-microphone/" data-toggle="tooltip" data-placement="top" title="(2/3)Retour du nsec - The visual microphone">&larr; Previous Post</a>
          </li>
        
        
      </ul>

      
        
      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:contact@enconn.fr" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/AmarOk1412" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/AmarOk1412" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="https://enconn.fr/index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.37.1</a> powered &nbsp;&bull;&nbsp; Original theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>, modified by <a href="https://enconn.fr">AmarOk</a>
          &nbsp;&bull;&nbsp;[<a href="true"></a>]
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://enconn.fr/js/main.js"></script>
<script src="https://enconn.fr/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>
<script src="https://enconn.fr/js/load-photoswipe.js"></script>




  </body>
</html>

