<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Git dissect - Enconn</title>
  <meta name="description" content="P2P internals - episode 4">
  <meta name="author" content="Sébastien Blin"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Enconn",
    
    "url": "https:\/\/enconn.fr"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/enconn.fr"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/enconn.fr",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/enconn.fr\/blog\/git-dissect\/",
          "name": "Git dissect"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Sébastien Blin"
  },
  "headline": "Git dissect",
  "description" : "It\u0026rsquo;s been a long time since my previous post, but let\u0026rsquo;s continue this serie about distributed systems with a tool that a lot of people use every day: git.\nGit is a versioning tool. Unlike some systems like subversion, you don\u0026rsquo;t need to have a server to use git. Every member of the project own a (partial or not) copy of the project and can directly send data to another member.",
  "inLanguage" : "en",
  "wordCount":  2857 ,
  "datePublished" : "2021-03-25T00:00:00",
  "dateModified" : "2021-03-25T00:00:00",
  "image" : "https:\/\/enconn.fr\/img\/avatar-icon.png",
  "keywords" : [ "p2p, dev, git" ],
  "mainEntityOfPage" : "https:\/\/enconn.fr\/blog\/git-dissect\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/enconn.fr",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/enconn.fr\/img\/avatar-icon.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Git dissect" />
<meta property="og:description" content="P2P internals - episode 4">
<meta property="og:image" content="https://enconn.fr/img/avatar-icon.png" />
<meta property="og:url" content="https://enconn.fr/blog/git-dissect/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Enconn" />

  <meta name="twitter:title" content="Git dissect" />
  <meta name="twitter:description" content="P2P internals - episode 4">
  <meta name="twitter:image" content="https://enconn.fr/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@AmarOk1412" />
  <meta name="twitter:creator" content="@AmarOk1412" />
  <link href='https://enconn.fr/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.80.0" />
  <link rel="alternate" href="https://enconn.fr/index.xml" type="application/rss+xml" title="Enconn"><link rel="stylesheet" href="https://enconn.fr/css/katex.min.css" />
  <link rel="stylesheet" href="https://enconn.fr/fontawesome/css/all.css" />
  <link rel="stylesheet" href="https://enconn.fr/css/bootstrap.min.css" /><link rel="stylesheet" href="https://enconn.fr/css/main.css" /><link rel="stylesheet" href="https://enconn.fr/css/fonts.css" />
  <link rel="stylesheet" href="https://enconn.fr/css/highlight.min.css" /><link rel="stylesheet" href="https://enconn.fr/css/codeblock.css" /><link rel="stylesheet" href="https://enconn.fr/css/photoswipe.min.css" />
  <link rel="stylesheet" href="https://enconn.fr/css/photoswipe.default-skin.min.css" />



  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://enconn.fr">Enconn</a> <div class="navbar-by">by AmarOk</div>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/blog/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Logs" href="/logs/">Logs</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/about/">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Enconn" href="https://enconn.fr">
            <img class="avatar-img" src="https://enconn.fr/img/avatar-icon.png" alt="Enconn" />
          </a>
        
      </div>
    </div>

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="blog-heading">
              
                <h1>Git dissect</h1>
              
              
                <hr class="small">
              
              
                
                  <h2 class="blog-subheading">P2P internals - episode 4</h2>
                
              
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>It&rsquo;s been a long time since my previous post, but let&rsquo;s continue this serie about distributed systems with a tool that a lot of people use every day: <em>git</em>.</p>
<p><em>Git</em> is a versioning tool. Unlike some systems like <em>subversion</em>, you don&rsquo;t need to have a server to use <em>git</em>. Every member of the project own a (partial or not) copy of the project and can directly send data to another member. So, even if today a lot of people use platforms like <a href="https://gitea.com/">Gitea</a>, <a href="https://gitlab.com/">GitLab</a>, <a href="https://github.com/">GitHub</a>, etc. it&rsquo;s possible to work without any of them (can be useful when the platform is down).</p>
<p>In this article I will <strong>not describe how to use <em>git</em></strong> because there is already plenty of articles about this  (e.g. <a href="https://try.github.io/)">https://try.github.io/)</a>. If you want to learn how to use <em>git</em>, this article is not for you. In this article, I will describe what is going on when you do <code>git clone https://github.com/zestedesavoir/zmarkdown/</code> from the network perspective and will describe how to implement a minimalist <em>git</em> server working on a custom protocol.</p>
<h1 id="what-is-a-git-transport">What is a git transport?</h1>
<h2 id="the-different-layers">The different layers</h2>
<p>To exchange information between a server and a client, <em>git</em> uses <em>packfiles</em> transmitted via the <code>pack-protocol</code> or the <code>http-protocol</code>. Both protocols have a similar logic, but in this article we will just check the <code>pack-protocol</code>. For the curious, here is the <a href="https://github.com/git/git/blob/master/Documentation/technical/http-protocol.txt">definition of the <code>http-protocol</code></a> (note that the documentation is still incomplete).</p>
<p>The protocols are offering two services:</p>
<ol>
<li><code>upload-pack</code> (server side, <code>fetch-pack</code> client side) to transmit data from server to client. We will check this part in detail.</li>
<li><code>received-pack</code> (server side, <code>send-pack</code> client side) to send data from client to server.</li>
</ol>
<p>Finally, protocols are used over various transports. <a href="https://git-scm.com/book/en/v2/Git-on-the-Server-The-Protocols">Four kinds of transports</a> are supported by default: <code>ssh://</code> (SSH), <code>file://</code> (a classic pipe), <code>git://</code> (<a href="https://git-scm.com/book/en/v2/Git-on-the-Server-Git-Daemon">a TCP server</a> generally combined with SSH for authentication) for the <code>pack-protocol</code> and <code>http://</code> for the <code>http-protocol</code>.</p>
<p>Note: the HTTP protocol is divided in two implementations. <code>Dumb</code> which are classic web servers providing files and <code>smart</code> where servers answer to requests.</p>
<p>So, this is what a <em>git</em> transport looks like:</p>
<table>
<thead>
<tr>
<th><code>upload-pack</code> OR <code>receive-pack</code></th>
<th><code>upload-pack</code> OR <code>receive-pack</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pack-protocol</code> + <code>pack-format</code></td>
<td><code>http-protocol</code> + <code>pack-format</code></td>
</tr>
<tr>
<td><code>ssh://</code>, <code>file://</code>, <code>git://</code></td>
<td><code>http://</code> ou <code>https://</code>.</td>
</tr>
</tbody>
</table>
<p>And this is what I will describe:</p>
<table>
<thead>
<tr>
<th><code>upload-pack</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pack-protocol</code> + <code>pack-format</code></td>
</tr>
<tr>
<td><code>custom://</code></td>
</tr>
</tbody>
</table>
<p>Finally, each protocols define two big notions, the <em>pkt-line format</em> and the <em>pack format</em>.</p>
<h3 id="the-pkt-line-format">The pkt-line format</h3>
<p>A <em>pkt-line</em> is a binary string. The first four bytes of this string are used to store the total length of the line via a hexadecimal string. So, a <em>pkt-line</em> starting with <code>0023</code> (<code>0x30,0x30,0x32,0x33</code>) is a <em>pkt-line</em> of 35 bytes.</p>
<p>There is some other things to know like:</p>
<ul>
<li>If the string is not a binary string (e.g. without any <code>\0</code>) it should finish with <code>LF</code> (<code>\n</code>) which is counted in the size.</li>
<li>It&rsquo;s forbidden to send the empty line: <code>0004</code>. The empty line (called <em>flush packet</em>) is <code>0000</code>.</li>
<li>The maximum size of a <em>pkt-line</em> is 65520 bytes, so 65516 bytes of data.</li>
</ul>
<p>E.g. if you want to send &ldquo;foobar&rdquo; the <em>pkt-line</em> will be <code>000bfoobar\n</code>.</p>
<h3 id="the-pack-format">The pack format</h3>
<p>Once the negotiation part is done, it&rsquo;s time to transmit objects! Those objects are transmitted via the pack format. A lot of libraries (like <em>libgit2</em> that we will use later) already have the abstraction to generate objects in this format, so, I won&rsquo;t dwell on it here.</p>
<p>However, if you want to fully understand how to create a <em>packfile</em>, you can read this <a href="https://git-scm.com/docs/pack-format">page</a>.</p>
<p>To summarize, this is generally what you will see:</p>
<table>
<thead>
<tr>
<th>Header</th>
<th>Data</th>
<th>Checksum </th>
</tr>
</thead>
<tbody>
<tr>
<td>signature (PACK), version (2), number of objects</td>
<td>type, content</td>
<td>trailer</td>
</tr>
</tbody>
</table>
<p>Where objects are transferred in four types (commit, tree, tag, blob) and can be compressed in something called a <em>deltified representation</em>.</p>
<h2 id="git-upload-pack-utterly-useless-therefore-essential">git upload-pack: utterly useless, therefore essential</h2>
<p><em>git</em> is a command with a loooooong list of subprograms. A lot are (hopefully) not necessary, but they are still interesting; like <code>git http-backend</code> (to play with the <code>http-protocol</code> mentioned before).  Yet, some of these commands only exist to be invoked by others (but <strong>never</strong> by the end-user). It&rsquo;s the case for <code>git upload-pack</code> that we will use to start to play with the <code>pack-protocol</code>. This program is used by <code>git fetch-pack</code> which is used by <code>git fetch</code>. It allows us to do a <code>git clone/fetch</code> by communicating with a server with <em>pkt-lines</em>.</p>
<p>This is an example of <code>git upload-pack</code> used on <a href="https://github.com/zestedesavoir/zmarkdown">ZMarkdown&rsquo;s repository</a>:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># https://github.com/zestedesavoir/zmarkdown</span>
<span class="c1"># `git clone git@github.com:zestedesavoir/zmarkdown.git`</span>
<span class="c1"># 7e31d5dcc19fa412df5674676f5fb7092d035275 is the current master</span>

$ <span class="nb">echo</span> <span class="s2">&#34;0032want 7e31d5dcc19fa412df5674676f5fb7092d035275\n00000009done\n&#34;</span> <span class="p">|</span> git upload-pack zmarkdown &gt; dump_git_upload_pack
</code></pre></div><p>To summarize, this command retrieves the tree of commits behind (and including) the commit <code>7e31d5dcc19fa412df5674676f5fb7092d035275</code> and write the whole content into <em>dump_git_upload_file</em>. You can check the content of this file if you want, but it&rsquo;s not important. However, if one day you need to read what a <em>git</em> server sends, you can check the file via <code>xxd dump_git_upload_pack | less</code> if you need to dissect a <em>packfile</em> or just <code>less dump_git_upload_pack</code> if you only care about the beginning of the transmission.</p>
<h1 id="how-a-git-server-works">How a git server works?</h1>
<p>Let&rsquo;s get down to the nitty gritty of how a git server works by exploring how to implement a minimal server answering to a <code>git clone</code> or <code>git fetch</code>.</p>
<h2 id="references-discovery">References discovery</h2>
<p>First, the client announces to the server what it wants by sending the <code>git upload-pack</code> command following this format:</p>
<table>
<thead>
<tr>
<th>pkt_len (4 bytes)</th>
<th>git-upload-pack</th>
<th>space</th>
<th>pathname</th>
<th>\0</th>
<th>host-parameter</th>
<th>\0</th>
<th>\0</th>
<th> extra-parameters</th>
<th>\0</th>
</tr>
</thead>
</table>
<p>For example:</p>
<pre><code>003dgit-upload-pack zmarkdown.git\0host=localhost\0\0version=1\0
</code></pre><p>Note that <code>version=1</code> is the only extra parameter accepted for now, and is totally optional. This will be valid too:</p>
<pre><code>0032git-upload-pack zmarkdown.git\0host=localhost\0
</code></pre><p>Then, for our server, it&rsquo;s time to send its references so that the client will know about what they can download. This is what the documentation says:</p>
<ul>
<li>If <code>version</code> is present in the extra parameters, the server starts by announcing its version <code>000eversion 1\n</code>.</li>
<li>Then it announces all known references and pointed hashes.</li>
<li>The list of references is sorted by name.</li>
<li>If HEAD is present, it must be the first announced reference.</li>
<li>The first reference is followed by <code>\0</code> followed by the supported features.</li>
<li>And it&rsquo;s finished by a <code>0000</code> (<em>flush-pkt</em>).</li>
</ul>
<p>Thus, the beginning of our negotiation looks like:</p>
<pre><code>C: 0028git-upload-pack /zdshost=localhost\0host=localhost\0
S: 006ac29eb686c3638633bff5b852ee1ed76211882ba1 HEAD\0side-band side-band-64k shallow no-progress include-tag
S: 003f7300c6f39366e2c0bcaf99efc05cc45e8511a384 refs/heads/master
S: 0046c29eb686c3638633bff5b852ee1ed76211882ba1 refs/remotes/origin/HEAD
S: 0048c29eb686c3638633bff5b852ee1ed76211882ba1 refs/remotes/origin/master
S: 0000
</code></pre><p>Our server can support a lot of features I will not describe in this article, but if both sides support <code>side-band</code> or <code>side-band-64k</code> the server sends data in a multiplexed format by chunks of 999 bytes for <code>side-band</code> or 65519 bytes for <code>side-band-64k</code> and one byte to specify the channel (described later). <code>no-progress</code> means that the server doesn&rsquo;t send the progress. Other properties are described <a href="https://git-scm.com/docs/protocol-capabilities">here</a>.</p>
<p>Now that our client knows what the server has, it&rsquo;s time to negotiate the packfile!</p>
<h2 id="packfile-negotiation">Packfile negotiation</h2>
<p>There&rsquo;s basically two possibilities for the client during this step. Either the client doesn&rsquo;t need any other data (for example after a <code>ls-remote</code>). In this case, it just sends a <code>0000</code> to close the connection. Or it enters in the negotiation phase. In this case, the client announces what commits are necessary, what commit it has and the supported features.</p>
<p>Then we can announce the wanted objects via some <code>want</code> lines (at least one, maximum 32). Wanted hashes must be in the list announced by the server. If the client has <em>shallowed copies</em> of some objects, it must be announced. Also, the maximum wanted depth is transmitted. Then, to obtain the minimal <em>packfile</em> a list of already downloaded commits must be sent.</p>
<p>Both the want-list and the have-list are followed by a <code>0000</code> packet.</p>
<p>After each have-list sent by the client, the server will ack common objects. Three different methods are supported:</p>
<ul>
<li><code>multi-ack</code> where:
<ul>
<li><code>ACK obj-id continue</code> is sent for the common commit,</li>
<li><code>ACK</code> for every commit when a common commit is found,</li>
<li><code>NAK</code> to wait a new response by the client</li>
</ul>
</li>
<li><code>multi-ack-detailed</code>:
<ul>
<li><code>ACK obj-id ready</code> and <code>ACK obj-id common</code> can be sent</li>
</ul>
</li>
<li>else:
<ul>
<li><code>ACK obj-id</code> on the first common commit then nothing until client sends <code>done</code>.</li>
<li><code>NAK</code> if it receives a flush packet and no common commit is found.</li>
</ul>
</li>
</ul>
<p>Then, the client decides if enough information is received. In that case, it sends a <code>0009done\n</code> packet. Else, a new have-list is sent until maximum 256 <code>have</code> (else all objects can be downloaded).</p>
<p>So, a clone looks like:</p>
<pre><code>C: 004dwant c42412dfee248e8acbd21df6038991dff6fd1b2a side-band-64k include-tag\n
C: 0000
C: 0009done\n
S: 0008NAK\n
</code></pre><p>and a fetch:</p>
<pre><code>C: 0057want 04930e2b1a6a4f92cb6bbc4fac9237383f052b81 multi_ack side-band-64k include-tag\n
C: 0000
C: 0032have 3648793596d9a971632b86805949d036ab5918a0\n
C: 0000
S: 003aACK 3648793596d9a971632b86805949d036ab5918a0 continue\n
S: 0008NAK\n
C: 0009done\n
S: 0031ACK 3648793596d9a971632b86805949d036ab5918a0\n
</code></pre><h2 id="sending-data">Sending data</h2>
<p>Finally, it&rsquo;s time to send the objects into a <em>packfile</em>. <code>libgit2</code>, the library I will use in the last part has the <code>PackBuilder</code> object, which is useful to prepare packfiles. On our side, it&rsquo;s just a matter of adding wanted commits. So, we add every commit between the wanted one and the commit with only one parent below the common commit. For example, if we add commits from two branches (and the common is only located in one branch) we add everything until the common commit of these two branches.</p>
<p>I also talked previously about <code>side-band-64k</code>. It means that the packfile will be sent by chunks of 64k via the pkt-line format. After the 4 bytes for the size, the following byte is the channel (<code>0x1</code> for the data channel, <code>0x2</code> for progress, <code>0x3</code> for errors) and finally <code>65515</code> bytes for the data.</p>
<p>To terminate the transfer, a flush packet is sent.</p>
<p>And that&rsquo;s it! Our <code>clone</code> is finished! Now let&rsquo;s implement a minimal git server supporting fetch and clone on a custom transport:</p>
<h1 id="a-minimal-git-server-in-rust">A minimal git server in Rust</h1>
<p>Note: you can get the code <a href="https://github.com/AmarOk1412/p2p-internals-git/">here</a>.</p>
<p>I&rsquo;ll use <a href="https://libgit2.org/">libgit2</a> because it provides methods to create the packfiles and interact with <em>git</em> repositories. It also handles custom transports. This lib has many wrappers, and I&rsquo;ll use the Rust one because I think it&rsquo;s the most complete (outside the C one): <a href="https://github.com/rust-lang/git2-rs/">git2-rs</a>. The main problem is that the <a href="https://libgit2.org/libgit2/#HEAD">documentation</a> is pretty incomplete and the whole part on <em>transport</em> is missing.
Let&rsquo;s use a completely fictional protocol, called WOLF (because <em>git</em> transmits <em>packfiles</em> we can talk about <a href="https://www.youtube.com/watch?v=u4_SbUcv7OY">wolf-pack</a>). This protocol is useless and only adds four bytes (&ldquo;WOLF&rdquo;) before each packet.</p>
<p>Our <code>src/wolftransport.rs</code> will be:</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="c1">// https://docs.rs/git2/0.13.17/git2/transport/fn.register.html
</span><span class="c1"></span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">bichannel</span>::<span class="p">{</span><span class="w"> </span><span class="n">SendError</span><span class="p">,</span><span class="w"> </span><span class="n">RecvError</span><span class="w"> </span><span class="p">};</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">git2</span>::<span class="n">Error</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">git2</span>::<span class="n">transport</span>::<span class="n">SmartSubtransportStream</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">git2</span>::<span class="n">transport</span>::<span class="p">{</span><span class="n">Service</span><span class="p">,</span><span class="w"> </span><span class="n">SmartSubtransport</span><span class="p">,</span><span class="w"> </span><span class="n">Transport</span><span class="p">};</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">io</span>::<span class="n">prelude</span>::<span class="o">*</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">sync</span>::<span class="p">{</span><span class="n">Arc</span><span class="p">,</span><span class="w"> </span><span class="n">Mutex</span><span class="p">};</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">static</span><span class="w"> </span><span class="n">HOST_TAG</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&#34;host=&#34;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1">// Note: this transport is useless, but is only here for an example.
</span><span class="c1">// Every packet is predeceased by a header of 4 bytes: &#34;WOLF&#34;.
</span><span class="c1"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">WolfChannel</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">channel</span>: <span class="nc">bichannel</span>::<span class="n">Channel</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">WolfChannel</span><span class="w">
</span><span class="w"></span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">recv</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">RecvError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">recv</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">res</span><span class="p">.</span><span class="n">is_ok</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="n">res</span><span class="p">.</span><span class="n">drain</span><span class="p">(</span><span class="mi">0</span><span class="p">..</span><span class="mi">4</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">send</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">data</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">SendError</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">to_send</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#34;WOLF&#34;</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">().</span><span class="n">to_vec</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="n">to_send</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">to_send</span><span class="p">)</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">type</span> <span class="nc">Channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span><span class="o">&lt;</span><span class="n">Mutex</span><span class="o">&lt;</span><span class="n">WolfChannel</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="sd">/**
</span><span class="sd"> * Now, let&#39;s write a smart transport for git2-rs to answer to the scheme wolf://
</span><span class="sd"> */</span><span class="w">
</span><span class="w"></span><span class="k">struct</span> <span class="nc">WolfTransport</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">channel</span>: <span class="nc">Channel</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">struct</span> <span class="nc">WolfSubTransport</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">action</span>: <span class="nc">Service</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">channel</span>: <span class="nc">Channel</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">url</span>: <span class="nb">String</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">sent_request</span>: <span class="kt">bool</span>
<span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c1">// git2 will use our smart transport for wolf://
</span><span class="c1"></span><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">register</span><span class="p">(</span><span class="n">channel</span>: <span class="nc">Channel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">git2</span>::<span class="n">transport</span>::<span class="n">register</span><span class="p">(</span><span class="s">&#34;wolf&#34;</span><span class="p">,</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">remote</span><span class="o">|</span><span class="w"> </span><span class="n">factory</span><span class="p">(</span><span class="n">remote</span><span class="p">,</span><span class="w"> </span><span class="n">channel</span><span class="p">.</span><span class="n">clone</span><span class="p">())).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">factory</span><span class="p">(</span><span class="n">remote</span>: <span class="kp">&amp;</span><span class="nc">git2</span>::<span class="n">Remote</span><span class="o">&lt;</span><span class="na">&#39;_</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">channel</span>: <span class="nc">Channel</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Transport</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">Transport</span>::<span class="n">smart</span><span class="p">(</span><span class="w">
</span><span class="w">        </span><span class="n">remote</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="c1">// rpc = false, this means that our channel is connected during all the transaction.
</span><span class="c1"></span><span class="w">        </span><span class="n">WolfTransport</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="n">channel</span><span class="w">
</span><span class="w">        </span><span class="p">},</span><span class="w">
</span><span class="w">    </span><span class="p">)</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">SmartSubtransport</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">WolfTransport</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="sd">/**
</span><span class="sd">     * Generate a new transport to use (because rpc = false), we will only answer to upload-pack-ls &amp; receive-pack-ls
</span><span class="sd">     */</span><span class="w">
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">action</span><span class="p">(</span><span class="w">
</span><span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="n">action</span>: <span class="nc">Service</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span><span class="w"> </span><span class="n">SmartSubtransportStream</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">WolfSubTransport</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="n">action</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">channel</span>: <span class="nc">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w">
</span><span class="w">            </span><span class="n">url</span>: <span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="n">url</span><span class="p">),</span><span class="w">
</span><span class="w">            </span><span class="n">sent_request</span>: <span class="nc">false</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="p">}))</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">close</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">WolfTransport</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">generate_request</span><span class="p">(</span><span class="n">cmd</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">url</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="c1">// url format = wolf://host/repo
</span><span class="c1"></span><span class="w">        </span><span class="c1">// Note: This request is sent when the client&#39;s part is starting, to notify the server about what we want to do.
</span><span class="c1"></span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">url</span><span class="p">.</span><span class="n">rfind</span><span class="p">(</span><span class="sc">&#39;/&#39;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">url</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">7</span><span class="p">..</span><span class="n">sep</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">repo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">url</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">sep</span><span class="p">..).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">null_char</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\0&#39;</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="w">                                   </span><span class="cm">/* 4 bytes for the len len */</span><span class="w">
</span><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">cmd</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w">                         </span><span class="cm">/* followed by the command */</span><span class="w">
</span><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">                                 </span><span class="cm">/* space */</span><span class="w">
</span><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">repo</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w">                        </span><span class="cm">/* repo to clone */</span><span class="w">
</span><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">                                 </span><span class="cm">/* \0 */</span><span class="w">
</span><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">HOST_TAG</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">host</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w">       </span><span class="cm">/* host=server */</span><span class="w">
</span><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w">                                 </span><span class="cm">/* \0 */</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;{:04x}{} {}{}{}{}{}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">total</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="n">repo</span><span class="p">,</span><span class="w"> </span><span class="n">null_char</span><span class="p">,</span><span class="w"> </span><span class="n">HOST_TAG</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">null_char</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="n">request</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">().</span><span class="n">to_vec</span><span class="p">()</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">Read</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">WolfSubTransport</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="c1">// send a request when  starting
</span><span class="c1"></span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">sent_request</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">action</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">                </span><span class="n">Service</span>::<span class="n">UploadPackLs</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#34;git-upload-pack&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">                </span><span class="n">Service</span>::<span class="n">UploadPack</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#34;git-upload-pack&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">                </span><span class="n">Service</span>::<span class="n">ReceivePackLs</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#34;git-receive-pack&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">                </span><span class="n">Service</span>::<span class="n">ReceivePack</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&#34;git-receive-pack&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="p">};</span><span class="w">
</span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WolfTransport</span>::<span class="n">generate_request</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="bp">self</span><span class="p">.</span><span class="n">url</span><span class="p">);</span><span class="w">
</span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">send</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span><span class="w">
</span><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">sent_request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">        </span><span class="c1">// Write what the server sends into buf.
</span><span class="c1"></span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">recv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">recv</span><span class="p">().</span><span class="n">unwrap_or</span><span class="p">(</span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">());</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">recv</span><span class="p">.</span><span class="n">drain</span><span class="p">(..);</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iter</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="n">buf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="p">;</span><span class="w">
</span><span class="w">            </span><span class="n">idx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">Write</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">WolfSubTransport</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">to_vec</span><span class="p">());</span><span class="w">
</span><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">())</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">flush</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">io</span>::<span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="c1">// Unused in our case
</span><span class="c1"></span><span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div><p>Then, we can do the server - <code>src/server.rs</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">wolftransport</span>::<span class="n">Channel</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">git2</span>::<span class="p">{</span><span class="w"> </span><span class="n">Buf</span><span class="p">,</span><span class="w"> </span><span class="n">Oid</span><span class="p">,</span><span class="w"> </span><span class="n">Repository</span><span class="p">,</span><span class="w"> </span><span class="n">Sort</span><span class="w"> </span><span class="p">};</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">cmp</span>::<span class="p">{</span><span class="w"> </span><span class="n">max</span><span class="p">,</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="p">};</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="kt">i64</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="kt">str</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">static</span><span class="w"> </span><span class="n">FLUSH_PKT</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&#34;0000&#34;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">static</span><span class="w"> </span><span class="n">NAK_PKT</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&#34;0008NAK\n&#34;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">static</span><span class="w"> </span><span class="n">DONE_PKT</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&#34;0009done\n&#34;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">static</span><span class="w"> </span><span class="n">WANT_CMD</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&#34;want&#34;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">static</span><span class="w"> </span><span class="n">HAVE_CMD</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&#34;have&#34;</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">static</span><span class="w"> </span><span class="n">UPLOAD_PACK_CMD</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="s">&#34;git-upload-pack&#34;</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="sd">/**
</span><span class="sd"> * Represents a git server working a our custom transport, serving a given repository
</span><span class="sd"> */</span><span class="w">
</span><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Server</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="n">repository</span>: <span class="nc">Repository</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">channel</span>: <span class="nc">Channel</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">wanted</span>: <span class="nb">String</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">common</span>: <span class="nb">String</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">have</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">buf</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span><span class="w">    </span><span class="n">stop</span>: <span class="kt">bool</span><span class="p">,</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">impl</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="sd">/**
</span><span class="sd">     * Creates a new Server for a given path and transport
</span><span class="sd">     * @param channel       Our custom transport
</span><span class="sd">     * @param path          Repository
</span><span class="sd">     * @return the server
</span><span class="sd">     */</span><span class="w">
</span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">channel</span>: <span class="nc">Channel</span><span class="p">,</span><span class="w"> </span><span class="n">path</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">repository</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Repository</span>::<span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="n">Self</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="n">repository</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">channel</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="n">wanted</span>: <span class="nb">String</span>::<span class="n">new</span><span class="p">(),</span><span class="w">
</span><span class="w">            </span><span class="n">common</span>: <span class="nb">String</span>::<span class="n">new</span><span class="p">(),</span><span class="w">
</span><span class="w">            </span><span class="n">have</span>: <span class="nb">Vec</span>::<span class="n">new</span><span class="p">(),</span><span class="w">
</span><span class="w">            </span><span class="n">buf</span>: <span class="nb">Vec</span>::<span class="n">new</span><span class="p">(),</span><span class="w">
</span><span class="w">            </span><span class="n">stop</span>: <span class="nc">false</span><span class="p">,</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">run</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="c1">// stop is set to true when the clone finished.
</span><span class="c1"></span><span class="w">        </span><span class="c1">// until then, answer to the client.
</span><span class="c1"></span><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">stop</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">recv</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">recv</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">recv</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">need_more_parsing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="c1">// Then client can send multiple pkt-lines in one buffer,
</span><span class="c1"></span><span class="w">        </span><span class="c1">// so, parse until ready to receive new orders.
</span><span class="c1"></span><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">need_more_parsing</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="n">need_more_parsing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">take</span><span class="p">());</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">parse</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="c1">// Parse pkt len
</span><span class="c1"></span><span class="w">        </span><span class="c1">// Reference: https://github.com/git/git/blob/master/Documentation/technical/protocol-common.txt#L51
</span><span class="c1"></span><span class="w">        </span><span class="c1">// The first four bytes define the length of the packet and 0000 is a FLUSH pkt
</span><span class="c1"></span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="n">is_some</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="n">unwrap</span><span class="p">());</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pkt_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">str</span>::<span class="n">from_utf8</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">4</span><span class="p">]).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pkt_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span>::<span class="n">from_str_radix</span><span class="p">(</span><span class="n">pkt_len</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pkt</span><span class="w"> </span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">drain</span><span class="p">(</span><span class="mi">0</span><span class="p">..</span><span class="n">pkt_len</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pkt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">str</span>::<span class="n">from_utf8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="n">pkt_len</span><span class="p">]).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;RECV: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">pkt</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">pkt</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">UPLOAD_PACK_CMD</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="c1">// Cf: https://github.com/git/git/blob/master/Documentation/technical/pack-protocol.txt#L166
</span><span class="c1"></span><span class="w">            </span><span class="c1">// References discovery
</span><span class="c1"></span><span class="w">            </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Upload pack command detected&#34;</span><span class="p">);</span><span class="w">
</span><span class="w">            </span><span class="c1">// NOTE: the upload-pack command can contains some parameters like version=1
</span><span class="c1"></span><span class="w">            </span><span class="c1">// For now git supports only version=1 so we can ignore this part for this article.
</span><span class="c1"></span><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">send_references_capabilities</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">pkt</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">WANT_CMD</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="c1">// Reference:
</span><span class="c1"></span><span class="w">            </span><span class="c1">// https://github.com/git/git/blob/master/Documentation/technical/pack-protocol.txt#L229
</span><span class="c1"></span><span class="w">            </span><span class="c1">// NOTE: a client may sends more than one want. Moreover, the first want line will sends
</span><span class="c1"></span><span class="w">            </span><span class="c1">// wanted capabilities such as `side-band-64, multi-ack, etc`. To simplify the code, we
</span><span class="c1"></span><span class="w">            </span><span class="c1">// just ignore capabilities &amp; mutli-lines
</span><span class="c1"></span><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">wanted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">9</span><span class="p">..</span><span class="mi">49</span><span class="p">).</span><span class="n">unwrap</span><span class="p">());</span><span class="w"> </span><span class="c1">// take just the commit id
</span><span class="c1"></span><span class="w">            </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Detected wanted commit: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">wanted</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">pkt</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">HAVE_CMD</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="c1">// Reference:
</span><span class="c1"></span><span class="w">            </span><span class="c1">// https://github.com/git/git/blob/master/Documentation/technical/pack-protocol.txt#L390
</span><span class="c1"></span><span class="w">            </span><span class="c1">// NOTE: improve this part for multi-ack
</span><span class="c1"></span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">have_commit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span>::<span class="n">from</span><span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="mi">9</span><span class="p">..</span><span class="mi">49</span><span class="p">).</span><span class="n">unwrap</span><span class="p">());</span><span class="w"> </span><span class="c1">// take just the commit id
</span><span class="c1"></span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">repository</span><span class="p">.</span><span class="n">find_commit</span><span class="p">(</span><span class="n">Oid</span>::<span class="n">from_str</span><span class="p">(</span><span class="o">&amp;*</span><span class="n">have_commit</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">is_ok</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">common</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">have_commit</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span><span class="w">
</span><span class="w">                    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Set common commit to: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">common</span><span class="p">);</span><span class="w">
</span><span class="w">                </span><span class="p">}</span><span class="w">
</span><span class="w">            </span><span class="p">}</span><span class="w">
</span><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">have</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">have_commit</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">pkt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DONE_PKT</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="c1">// Reference:
</span><span class="c1"></span><span class="w">            </span><span class="c1">// https://github.com/git/git/blob/master/Documentation/technical/pack-protocol.txt#L390
</span><span class="c1"></span><span class="w">            </span><span class="c1">// NOTE: Do not do multi-ack, just send ACK + pack file
</span><span class="c1"></span><span class="w">            </span><span class="c1">// In case of no common base, send NAK
</span><span class="c1"></span><span class="w">            </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Peer negotiation is done. Answering to want order&#34;</span><span class="p">);</span><span class="w">
</span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">send_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">                </span><span class="kc">true</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">nak</span><span class="p">(),</span><span class="w">
</span><span class="w">                </span><span class="kc">false</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ack_first</span><span class="p">(),</span><span class="w">
</span><span class="w">            </span><span class="p">};</span><span class="w">
</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">send_data</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">send_pack_data</span><span class="p">();</span><span class="w">
</span><span class="w">            </span><span class="p">}</span><span class="w">
</span><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">pkt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FLUSH_PKT</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">have</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">                </span><span class="c1">// Reference:
</span><span class="c1"></span><span class="w">                </span><span class="c1">// https://github.com/git/git/blob/master/Documentation/technical/pack-protocol.txt#L390
</span><span class="c1"></span><span class="w">                </span><span class="c1">// NOTE: Do not do multi-ack, just send ACK + pack file In case of no common base ACK
</span><span class="c1"></span><span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">ack_common</span><span class="p">();</span><span class="w">
</span><span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">nak</span><span class="p">();</span><span class="w">
</span><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">wanted</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">stop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span><span class="w">
</span><span class="w">            </span><span class="p">}</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Unwanted packet received: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">pkt</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">send_references_capabilities</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">current_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">repository</span><span class="p">.</span><span class="n">refname_to_id</span><span class="p">(</span><span class="s">&#34;HEAD&#34;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">capabilities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;{} HEAD\0side-band side-band-64k shallow no-progress include-tag multi_ack&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">current_head</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="n">capabilities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;{:04x}{}\n&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">capabilities</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="cm">/* size + \n */</span><span class="p">,</span><span class="w"> </span><span class="n">capabilities</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">repository</span><span class="p">.</span><span class="n">references</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">names</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">reference</span>: <span class="kp">&amp;</span><span class="kt">str</span> <span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">repository</span><span class="p">.</span><span class="n">refname_to_id</span><span class="p">(</span><span class="n">reference</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">            </span><span class="n">capabilities</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;{:04x}{} {}\n&#34;</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="cm">/* size + space + \n */</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="cm">/* oid */</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">reference</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="n">oid</span><span class="p">,</span><span class="w"> </span><span class="n">reference</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">        </span><span class="n">print</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Send: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">capabilities</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">send</span><span class="p">(</span><span class="n">capabilities</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">().</span><span class="n">to_vec</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Send: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">FLUSH_PKT</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">send</span><span class="p">(</span><span class="n">FLUSH_PKT</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">().</span><span class="n">to_vec</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">nak</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">print</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Send: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">NAK_PKT</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">send</span><span class="p">(</span><span class="n">NAK_PKT</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">().</span><span class="n">to_vec</span><span class="p">()).</span><span class="n">is_ok</span><span class="p">()</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">ack_common</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="cm">/* size + ACK + space * 2 + continue + \n */</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">len</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;{:04x}ACK {} continue\n&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">common</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="n">print</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Send: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">().</span><span class="n">to_vec</span><span class="p">()).</span><span class="n">is_ok</span><span class="p">()</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">ack_first</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="cm">/* size + ACK + space + \n */</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">len</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;{:04x}ACK {}\n&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">common</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="n">print</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Send: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">().</span><span class="n">to_vec</span><span class="p">()).</span><span class="n">is_ok</span><span class="p">()</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="k">fn</span> <span class="nf">send_pack_data</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Send: [PACKFILE]&#34;</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="c1">// Note: this part of the code adds every commits into
</span><span class="c1"></span><span class="w">        </span><span class="c1">// the packfile until a commit announced by the client
</span><span class="c1"></span><span class="w">        </span><span class="c1">// is found AND a common parent is found (or until the
</span><span class="c1"></span><span class="w">        </span><span class="c1">// initial commit).
</span><span class="c1"></span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">repository</span><span class="p">.</span><span class="n">packbuilder</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">fetched</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Oid</span>::<span class="n">from_str</span><span class="p">(</span><span class="o">&amp;*</span><span class="bp">self</span><span class="p">.</span><span class="n">wanted</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">revwalk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">repository</span><span class="p">.</span><span class="n">revwalk</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">revwalk</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">fetched</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">revwalk</span><span class="p">.</span><span class="n">set_sorting</span><span class="p">(</span><span class="n">Sort</span>::<span class="n">TOPOLOGICAL</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">parents</span><span class="w"> </span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">oid</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">revwalk</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">oid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oid</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">oid_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oid</span><span class="p">.</span><span class="n">to_string</span><span class="p">();</span><span class="w">
</span><span class="w">            </span><span class="n">have</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">have</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="o">|&amp;</span><span class="n">o</span><span class="o">|</span><span class="w"> </span><span class="o">*</span><span class="n">o</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">oid_str</span><span class="p">).</span><span class="n">is_some</span><span class="p">();</span><span class="w">
</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parents</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">position</span><span class="p">(</span><span class="o">|</span><span class="n">p</span><span class="o">|</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">oid_str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">                </span><span class="n">parents</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span><span class="w">
</span><span class="w">            </span><span class="p">}</span><span class="w">
</span><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">parents</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">                </span><span class="c1">// All commits are fetched
</span><span class="c1"></span><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w">
</span><span class="w">            </span><span class="p">}</span><span class="w">
</span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pb</span><span class="p">.</span><span class="n">insert_commit</span><span class="p">(</span><span class="n">oid</span><span class="p">);</span><span class="w">
</span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">commit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">repository</span><span class="p">.</span><span class="n">find_commit</span><span class="p">(</span><span class="n">oid</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">commit_parents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">commit</span><span class="p">.</span><span class="n">parents</span><span class="p">();</span><span class="w">
</span><span class="w">            </span><span class="c1">// Make sure to explore every branches.
</span><span class="c1"></span><span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">commit_parents</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">                </span><span class="n">parents</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="p">().</span><span class="n">to_string</span><span class="p">());</span><span class="w">
</span><span class="w">            </span><span class="p">}</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">        </span><span class="c1">// Note: the buf can be huge. Packbuilder has some methods to get chunks.
</span><span class="c1"></span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Buf</span>::<span class="n">new</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pb</span><span class="p">.</span><span class="n">write_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">data</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">to_vec</span><span class="p">();</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">            </span><span class="c1">// cf https://github.com/git/git/blob/master/Documentation/technical/pack-protocol.txt#L166
</span><span class="c1"></span><span class="w">            </span><span class="c1">// In &#39;side-band-64k&#39; mode it will send up to 65519 data bytes plus 1 control code, for a
</span><span class="c1"></span><span class="w">            </span><span class="c1">// total of up to 65520 bytes in a pkt-line.
</span><span class="c1"></span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">pkt_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min</span><span class="p">(</span><span class="mi">65515</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sent</span><span class="p">);</span><span class="w">
</span><span class="w">            </span><span class="c1">// The packet is Size (4 bytes), Control byte (0x01 for data), pack data.
</span><span class="c1"></span><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">pkt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;{:04x}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">pkt_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="cm">/* size + control */</span><span class="p">);</span><span class="w">
</span><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">send</span><span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">().</span><span class="n">to_vec</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">send</span><span class="p">(</span><span class="s">b&#34;</span><span class="se">\x01</span><span class="s">&#34;</span><span class="p">.</span><span class="n">to_vec</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">sent</span><span class="p">..(</span><span class="n">sent</span><span class="o">+</span><span class="n">pkt_size</span><span class="p">)].</span><span class="n">to_vec</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">            </span><span class="n">sent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">pkt_size</span><span class="p">;</span><span class="w">
</span><span class="w">        </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Send: {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">FLUSH_PKT</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="c1">// And finish by a little FLUSH
</span><span class="c1"></span><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">channel</span><span class="p">.</span><span class="n">lock</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">send</span><span class="p">(</span><span class="n">FLUSH_PKT</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">().</span><span class="n">to_vec</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div><p>Finally <code>src/main.rs</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-rust" data-lang="rust"><span class="k">mod</span> <span class="nn">wolftransport</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">mod</span> <span class="nn">server</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">bichannel</span>::<span class="n">channel</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">wolftransport</span>::<span class="n">WolfChannel</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">git2</span>::<span class="n">build</span>::<span class="n">RepoBuilder</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">server</span>::<span class="n">Server</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">env</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">sync</span>::<span class="p">{</span><span class="n">Arc</span><span class="p">,</span><span class="w"> </span><span class="n">Mutex</span><span class="p">};</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">thread</span><span class="p">;</span><span class="w">
</span><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">path</span>::<span class="n">Path</span><span class="p">;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">args</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">env</span>::<span class="n">args</span><span class="p">().</span><span class="n">collect</span><span class="p">();</span><span class="w">
</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Usage: ./p2p-internal-git &lt;src_dir&gt; &lt;dest_dir&gt;&#34;</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">    
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">src_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">clone</span><span class="p">();</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dest_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c1">// For fetch, comment the 4 following lines
</span><span class="c1"></span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">dest_dir</span><span class="p">.</span><span class="n">is_dir</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Can&#39;t clone into an existing directory&#34;</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c1">// Note: here we use a mpsc::channel for demo purposes, but
</span><span class="c1"></span><span class="w">    </span><span class="c1">// the transport can be on top of anything you want/need.
</span><span class="c1"></span><span class="w">    </span><span class="c1">// It can be replaced by a real server with TLS support for
</span><span class="c1"></span><span class="w">    </span><span class="c1">// example.
</span><span class="c1"></span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">server_channel</span><span class="p">,</span><span class="w"> </span><span class="n">transport_channel</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">channel</span><span class="p">();</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">transport_channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">Mutex</span>::<span class="n">new</span><span class="p">(</span><span class="n">WolfChannel</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">channel</span>: <span class="nc">transport_channel</span><span class="w">
</span><span class="w">    </span><span class="p">}));</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">server_channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Arc</span>::<span class="n">new</span><span class="p">(</span><span class="n">Mutex</span>::<span class="n">new</span><span class="p">(</span><span class="n">WolfChannel</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">channel</span>: <span class="nc">server_channel</span><span class="w">
</span><span class="w">    </span><span class="p">}));</span><span class="w">
</span><span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">wolftransport</span>::<span class="n">register</span><span class="p">(</span><span class="n">transport_channel</span><span class="p">);</span><span class="w">
</span><span class="w">    </span><span class="p">}</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">thread</span>::<span class="n">spawn</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w">
</span><span class="w">        </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Starting server for {}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">src_dir</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Server</span>::<span class="n">new</span><span class="p">(</span><span class="n">server_channel</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;*</span><span class="n">src_dir</span><span class="p">);</span><span class="w">
</span><span class="w">        </span><span class="n">server</span><span class="p">.</span><span class="n">run</span><span class="p">();</span><span class="w">
</span><span class="w">    </span><span class="p">});</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c1">// For fetch
</span><span class="c1"></span><span class="w">    </span><span class="c1">// let repository = git2::Repository::open(dest_dir).unwrap();
</span><span class="c1"></span><span class="w">    </span><span class="c1">// let mut remote = repository.remote_anonymous(&#34;wolf://localhost/zds&#34;).unwrap();
</span><span class="c1"></span><span class="w">    </span><span class="c1">// let mut fo = git2::FetchOptions::new();
</span><span class="c1"></span><span class="w">    </span><span class="c1">// remote.fetch(&amp;[] as &amp;[&amp;str], Some(&amp;mut fo), None).unwrap();
</span><span class="c1"></span><span class="w">
</span><span class="w">    </span><span class="c1">// For clone
</span><span class="c1"></span><span class="w">    </span><span class="n">RepoBuilder</span>::<span class="n">new</span><span class="p">().</span><span class="n">clone</span><span class="p">(</span><span class="s">&#34;wolf://localhost/zds&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">dest_dir</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w">
</span><span class="w">    </span><span class="c1">// Note: &#34;wolf://&#34; triggers our registered transport. localhost/zds is unused
</span><span class="c1"></span><span class="w">    </span><span class="c1">// as our server only serves one repository and the address is not resolved.
</span><span class="c1"></span><span class="w">    </span><span class="n">println</span><span class="o">!</span><span class="p">(</span><span class="s">&#34;Cloned into {:?}!&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">dest_dir</span><span class="p">);</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="n">server</span><span class="p">.</span><span class="n">join</span><span class="p">().</span><span class="n">expect</span><span class="p">(</span><span class="s">&#34;The server panicked&#34;</span><span class="p">);</span><span class="w">
</span><span class="w"></span><span class="p">}</span><span class="w">
</span></code></pre></div><p>And <code>Cargo.toml</code>:</p>
<pre><code>[package]
name = &quot;p2p-internals-git&quot;
version = &quot;0.1.0&quot;
authors = [&quot;AmarOk&quot;]
edition = &quot;2018&quot;

[dependencies]
bichannel = &quot;0.0.4&quot;
git2 = { git = &quot;https://github.com/AmarOk1412/git2-rs&quot; }
</code></pre><p>Now, we can use the program to copy a <em>git</em> repository from one directory to another:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># Note, multi-ack is not supported, so just clone the master branch without the tags</span>
 amarok@tars3  ~/Projects/p2p-internals-git   main  git clone -b master --single-branch --no-tags https://github.com/zestedesavoir/zmarkdown.git
Cloning into <span class="s1">&#39;zmarkdown&#39;</span>...
remote: Enumerating objects: 1207, <span class="k">done</span>.
remote: Counting objects: 100% <span class="o">(</span>1207/1207<span class="o">)</span>, <span class="k">done</span>.
remote: Compressing objects: 100% <span class="o">(</span>206/206<span class="o">)</span>, <span class="k">done</span>.
remote: Total <span class="m">16609</span> <span class="o">(</span>delta 1006<span class="o">)</span>, reused <span class="m">1192</span> <span class="o">(</span>delta 1001<span class="o">)</span>, pack-reused <span class="m">15402</span>
Receiving objects: 100% <span class="o">(</span>16609/16609<span class="o">)</span>, 10.85 MiB <span class="p">|</span> 2.25 MiB/s, <span class="k">done</span>.
Resolving deltas: 100% <span class="o">(</span>11966/11966<span class="o">)</span>, <span class="k">done</span>.
<span class="c1"># Then, the magic:</span>
 amarok@tars3  ~/Projects/p2p-internals-git   main  ./target/debug/p2p-internals-git zmarkdown zmarkdown-copy                                   
Starting server <span class="k">for</span> zmarkdown
RECV: 0028git-upload-pack /zdshost<span class="o">=</span>localhost
Upload pack <span class="nb">command</span> detected
Send: 0074c42412dfee248e8acbd21df6038991dff6fd1b2a HEADside-band side-band-64k shallow no-progress include-tag multi_ack
Send: 003fc42412dfee248e8acbd21df6038991dff6fd1b2a refs/heads/master
Send: 0046c42412dfee248e8acbd21df6038991dff6fd1b2a refs/remotes/origin/HEAD
Send: 0048c42412dfee248e8acbd21df6038991dff6fd1b2a refs/remotes/origin/master
Send: <span class="m">0000</span>
RECV: 0057want c42412dfee248e8acbd21df6038991dff6fd1b2a multi_ack side-band-64k include-tag 

Detected wanted commit: c42412dfee248e8acbd21df6038991dff6fd1b2a
RECV: <span class="m">0000</span>
RECV: 0009done

Peer negotiation is <span class="k">done</span>. Answering to want order
Send: 0008NAK
Send: <span class="o">[</span>PACKFILE<span class="o">]</span>
Send: <span class="m">0000</span>
Cloned into <span class="s2">&#34;zmarkdown-copy&#34;</span>!
<span class="c1"># And we can validate</span>
 amarok@tars3  ~/Projects/p2p-internals-git   main  git -C zmarkdown rev-parse HEAD
c42412dfee248e8acbd21df6038991dff6fd1b2a
 amarok@tars3  ~/Projects/p2p-internals-git   main  git -C zmarkdown-copy rev-parse HEAD 
c42412dfee248e8acbd21df6038991dff6fd1b2a
</code></pre></div><p>And that&rsquo;s all! We did a minimal <em>git</em> server able to clone a repository. Sure, it&rsquo;s far from complete and there is a lot of missing features, but I hope I have enlightened you about how <em>git</em> exchanges data between a client and a server.</p>
<h2 id="references">References</h2>
<p>Thanks for reading! If you want to dig the subject, this is a list of references I used for this article or for related projects:</p>
<ul>
<li><a href="https://libgit2.org/libgit2/#HEAD">https://libgit2.org/libgit2/#HEAD</a> (<strong>!!Warning, the doc is pretty incomplete, the transport part is missing!!</strong>)</li>
<li><a href="https://docs.rs/git2/0.13.17/git2/">https://docs.rs/git2/0.13.17/git2/</a> the Rust wrapper, which is pretty good</li>
<li><a href="https://git-scm.com/docs/">https://git-scm.com/docs/</a> &amp; <a href="https://github.com/git/git/blob/master/Documentation/technical/">https://github.com/git/git/blob/master/Documentation/technical/</a> describing how protocols used by <em>git</em> works.</li>
<li><a href="https://github.com/rust-lang/git2-rs/tree/master/git2-curl">https://github.com/rust-lang/git2-rs/tree/master/git2-curl</a> et <a href="https://github.com/libgit2/libgit2/blob/main/src/transports/git.c">https://github.com/libgit2/libgit2/blob/main/src/transports/git.c</a> for custom transport with <em>libgit2</em></li>
<li><a href="https://github.com/AmarOk1412/p2p-internals-git/">https://github.com/AmarOk1412/p2p-internals-git/</a></li>
</ul>


        
          <div class="blog-tags">
            
              <a href="https://enconn.fr/tags/p2p/">p2p</a>&nbsp;
            
              <a href="https://enconn.fr/tags/dev/">dev</a>&nbsp;
            
              <a href="https://enconn.fr/tags/git/">git</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://enconn.fr/blog/onion-address/" data-toggle="tooltip" data-placement="top" title="This blog has a .onion address">&larr; Previous Post</a>
            </li>
          
          
        </ul>
      


      
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:contact@enconn.fr" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/AmarOk1412" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/AmarOk1412" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://mastodon.social/@amarok" title="Mastodon">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-mastodon fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="https://enconn.fr">Sébastien Blin</a>
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2021
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://enconn.fr">Enconn</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.80.0</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://enconn.fr/js/katex.min.js"></script>
<script src="https://enconn.fr/js/auto-render.min.js"></script>
<script src="https://enconn.fr/js/jquery.min.js"></script>
<script src="https://enconn.fr/js/bootstrap.min.js"></script>

<script src="https://enconn.fr/js/main.js"></script>
<script src="https://enconn.fr/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script><script src="https://enconn.fr/js/photoswipe.min.js"></script>
<script src="https://enconn.fr/js/photoswipe-ui-default.min.js"></script><script src="https://enconn.fr/js/load-photoswipe.js"></script>









    
  </body>
</html>

